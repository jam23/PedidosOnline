@{
    ViewBag.Title = "Pedidos";
}
<link href="http://code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css" rel="stylesheet" />
<div class="row">
    <div class="col-sm-12">
        <h2>Pedidos</h2>
    </div>
</div>
<div class="row">
    <div class="col-sm-12">
        <p>Pedido # 12432335</p>
        <p>11/12/2014</p>
    </div>
</div>
<div class="row">
    <div class="col-sm-6">
        <form role="form">
            <div class="form-group">
                <label for="client">Cliente</label>
                <input class="form-control" id="client" type="text" name="client" value="" />
            </div>
            <div class="form-group">
                <label for="client">Almacen</label>
                <input class="form-control" id="store" type="text" name="client" value="" />
            </div>
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#article-modal">
                Agregar articulo
            </button>
            <button type="button" id="guardar" class="btn btn-primary">
                Guardar pedido
            </button>
        </form>
    </div>
</div>
<div class="row">
    <div class="col-sm-12">
        <h3>Articulos</h3>
        <table id="articles" class="table">
            <thead>
                <tr>
                    <th>Codigo
                    </th>
                    <th>Descripcion
                    </th>
                    <th>Cantidad
                    </th>
                    <th>Precio
                    </th>
                    <th>Descuento
                    </th>
                    <th>Impuestos
                    </th>
                </tr>
            </thead>
            <tbody id="articles-body">
            </tbody>
        </table>
    </div>
</div>
<div class="row">
    <div class="col-sm-12">
        <table id="summary" class="table">
            <thead>
                <tr>
                    <th>Sub-total</th>
                    <th>Descuentos</th>
                    <th>Impuestos</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody id="articles-summary">
                <tr>
                    <td></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
<div class="modal fade" id="article-modal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Cerrar</span></button>
                <h4 class="modal-title">Agregar articulo</h4>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="codigo">Codigo</label>
                    <input id="codigo" class="form-control" type="text" name="codigo" value="" />
                </div>
                <div class="form-group">
                    <label for="descripcion">Descripcion</label>
                    <input id="descripcion" class="form-control" type="text" name="descripcion" value="" disabled />
                </div>
                <div class="form-group">
                    <label for="cantidad">Cantidad</label>
                    <input id="cantidad" class="form-control" type="text" name="cantidad" value="" />
                </div>
                <div class="form-group">
                    <label for="precio">Precio</label>
                    <input id="precio" class="form-control" type="text" name="precio" value="" disabled />
                </div>
                <div class="form-group">
                    <label for="descuento">Descuento</label>
                    <input id="descuento" class="form-control" type="text" name="descuento" value="" />
                </div>
                <div class="form-group">
                    <label for="impuesto">Impuesto</label>
                    <input id="impuesto" class="form-control" type="text" name="impuesto" value="" />
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                <button type="button" id="agregar" class="btn btn-primary">Agregar</button>
            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

@section scripts{
    <script src="~/Scripts/jquery-ui.min.js"></script>
    <script src="~/Scripts/mustache.js"></script>
    <script>
        var pedido = {
            Header: {
                ClienteId: 001,
                Fecha: '2012-01-01'
            },
            Body: {
                Articulos: []
            }
        };

        $(function () {
            $('#agregar').click(function (e) {
                e.preventDefault();

                var template = ['<tr>', '<td>{{codigo}}</td>', '<td>{{descripcion}}</td>', '<td>{{cantidad}}</td>', '<td>{{precio}}</td>', '<td>{{descuento}}</td>', '<td>{{impuesto}}</td>', '</tr>'].join('');
                var articulo = {
                    codigo: $('#codigo').val(),
                    descripcion: $('#descripcion').val(),
                    cantidad: $('#cantidad').val(),
                    precio: $('#precio').val(),
                    descuento: $('#descuento').val(),
                    impuesto: $('#impuesto').val()
                };
                var html = Mustache.render(template, articulo);

                pedido.Body.Articulos.push(articulo);

                $('#articles-body').append(html);
                $('#article-modal').modal('hide');
                clear();
            });

            $('#guardar').click(function (e) {
                e.preventDefault();

                $.postJSON('@Url.Action("SaveRequest")', pedido, function (data) {
                    // algo
                });
            });

            var clear = function () {
                $('#codigo').val('');
                $('#descripcion').val('');
                $('#cantidad').val('');
                $('#precio').val('');
                $('#descuento').val('');
                $('#impuesto').val('');
            };

            $.postJSON = function (url, data, SuccessCallback, FailCallback) {
                return jQuery.ajax({
                    'type': 'POST',
                    'url': url,
                    'contentType': 'application/json',
                    'data': JSON.stringify(data),
                    'dataType': 'json',
                    'success': SuccessCallback,
                    'fail': FailCallback
                });
            };


            $("#codigo").autocomplete({
                source: '@Url.Action("AutoComplete")',
                minLength: 2,
                select: function (event, ui) {

                    $("#codigo").val(ui.item.Codigo);
                    document.getElementById("descripcion").value = ui.item.Descripcion;
                    document.getElementById("precio").value = ui.item.PrecioCompra;
                    document.getElementById("impuesto").disabled = ui.item.Impuesto;

                    return false;
                }
            }).autocomplete("instance")._renderItem = function (ul, item) {
                return $("<li>")
                  .append("<a>" + item.Descripcion + "</a>")
                  .appendTo(ul);
            };

        });

    </script>
}